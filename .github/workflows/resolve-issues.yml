name: Resolve GitHub Issues with AI

on:
  issues:
    types: [opened, reopened]
  schedule:
    # 毎日午前9時 (JST) = UTC 0:00
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: '特定のIssue番号を指定（空欄で全オープンIssue）'
        required: false
        type: string

permissions:
  contents: write
  issues: write

jobs:
  resolve-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli
      
      - name: Get issues to process
        id: get-issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            # Issue作成/再オープン時は該当Issueのみ
            echo "issues=[${{ github.event.issue.number }}]" >> $GITHUB_OUTPUT
          elif [[ -n "${{ inputs.issue_number }}" ]]; then
            # 手動実行で特定Issue指定時
            echo "issues=[${{ inputs.issue_number }}]" >> $GITHUB_OUTPUT
          else
            # 定時実行時は全オープンIssue
            ISSUES=$(gh issue list --state open --json number --jq '[.[].number]')
            echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          fi
      
      - name: Process issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ISSUES='${{ steps.get-issues.outputs.issues }}'
          
          for ISSUE_NUM in $(echo "$ISSUES" | jq -r '.[]'); do
            echo "Processing Issue #${ISSUE_NUM}..."
            
            # Issue詳細を取得
            ISSUE_DATA=$(gh issue view "$ISSUE_NUM" --json title,body)
            TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
            BODY=$(echo "$ISSUE_DATA" | jq -r '.body')
            
            # プロンプトを構築
            PROMPT="あなたはeegflowプロジェクトの開発者です。以下のGitHub Issueを解決してください。

          ## Issue #${ISSUE_NUM}: ${TITLE}

          ${BODY}

          ---

          リポジトリの構造を確認し、適切なファイルを修正してください。"

            # Gemini CLIで解決（非対話モード）
            echo "$PROMPT" | timeout 300 gemini --yolo -o text || {
              echo "Warning: Failed to resolve Issue #${ISSUE_NUM}"
              continue
            }
            
            # 変更があればコミット
            if ! git diff --quiet || ! git diff --staged --quiet; then
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add -A
              git commit -m "Fixes #${ISSUE_NUM}: ${TITLE}

          自動生成による修正

          Co-authored-by: gemini-cli <noreply@google.com>"
              git push
              echo "Issue #${ISSUE_NUM} resolved and pushed."
            else
              echo "No changes for Issue #${ISSUE_NUM}"
            fi
          done
      
      - name: Summary
        run: echo "Issue resolution workflow completed."
